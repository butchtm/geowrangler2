<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Building Poverty Mapping Machine Learning (ML) Models with geowrangler2">

<title>geowrangler2 - Explore Poverty Mapping Machine Learning Models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="geowrangler2 - Explore Poverty Mapping Machine Learning Models">
<meta property="og:description" content="Building Poverty Mapping Machine Learning (ML) Models with geowrangler2">
<meta property="og:image" content="https://butchtm.github.io/geowrangler2/images/dhs-cluster-features-zoomed.png">
<meta property="og:site-name" content="geowrangler2">
<meta name="twitter:title" content="geowrangler2 - Explore Poverty Mapping Machine Learning Models">
<meta name="twitter:description" content="Building Poverty Mapping Machine Learning (ML) Models with geowrangler2">
<meta name="twitter:image" content="https://butchtm.github.io/geowrangler2/images/dhs-cluster-features-zoomed.png">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">geowrangler2</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./overview.poverty_mapping_demo.html">Use Case Demos</a></li><li class="breadcrumb-item"><a href="./overview.poverty_mapping_demo.html">Explore Poverty Mapping Machine Learning Models</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Geowrangler</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./core.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sample Core</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Tutorials</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tutorial.grids.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Grid Generation Tutorial</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tutorial.geometry_validation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Geometry Validation Tutorial</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tutorial.vector_zonal_stats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Vector Zonal Stats Tutorial</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tutorial.raster_zonal_stats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Raster Zonal Stats Tutorial</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tutorial.area_zonal_stats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Vector Area Zonal Stats Tutorial</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tutorial.distance_zonal_stats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Vector Distance Zonal Stats Tutorial</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tutorial.dhs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DHS Wealth Index</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tutorial.datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Datasets Download</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tutorial.spatialjoin_highest_intersection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Spatial Join Using Highest Intersection Tutorial</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tutorial.tile_clustering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tile Clustering Tutorial</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tutorial.raster_process.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Raster Processing Tutorial</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Use Case Demos</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./overview.poverty_mapping_demo.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Explore Poverty Mapping Machine Learning Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./overview.usecase_ookla.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exploring Internet Speeds with Ookla</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./grids.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Grids</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./validation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Geometry Validation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./vector_zonal_stats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Vector Zonal Stats</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./raster_zonal_stats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Raster Zonal Stats</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./area_zonal_stats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Area Zonal Stats</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./distance_zonal_stats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Distance Zonal Stats</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./vector_to_raster_mask.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Vector to Raster mask</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./raster_to_dataframe.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Raster to Dataframe</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./raster_process.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Raster Processing</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dhs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DHS Utilities</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datasets_geofabrik.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Datasets Geofabrik</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datasets_ookla.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Datasets Ookla</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datasets_nightlights.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Night Lights</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datasets_utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Datasets Utils</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tile_clustering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tile Clustering</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spatialjoin_highest_intersection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Spatial Join Highest Intersection</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#set-up" id="toc-set-up" class="nav-link active" data-scroll-target="#set-up">Set-up</a></li>
  <li><a href="#pre-requisite-manual-data-download" id="toc-pre-requisite-manual-data-download" class="nav-link" data-scroll-target="#pre-requisite-manual-data-download">Pre-requisite: Manual Data Download</a></li>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation">Data Preparation</a>
  <ul class="collapse">
  <li><a href="#dhs-ground-truth" id="toc-dhs-ground-truth" class="nav-link" data-scroll-target="#dhs-ground-truth">DHS Ground Truth</a></li>
  <li><a href="#download-data-and-load-them-into-memory" id="toc-download-data-and-load-them-into-memory" class="nav-link" data-scroll-target="#download-data-and-load-them-into-memory">Download data and load them into memory</a></li>
  <li><a href="#ookla" id="toc-ookla" class="nav-link" data-scroll-target="#ookla">Ookla</a></li>
  <li><a href="#osm-open-street-maps" id="toc-osm-open-street-maps" class="nav-link" data-scroll-target="#osm-open-street-maps">OSM (Open Street Maps)</a></li>
  </ul></li>
  <li><a href="#feature-engineering" id="toc-feature-engineering" class="nav-link" data-scroll-target="#feature-engineering">Feature Engineering</a>
  <ul class="collapse">
  <li><a href="#osm" id="toc-osm" class="nav-link" data-scroll-target="#osm">OSM</a></li>
  <li><a href="#ookla-1" id="toc-ookla-1" class="nav-link" data-scroll-target="#ookla-1">Ookla</a></li>
  <li><a href="#night-time-lights" id="toc-night-time-lights" class="nav-link" data-scroll-target="#night-time-lights">Night Time Lights</a></li>
  <li><a href="#visualize-the-final-dataset" id="toc-visualize-the-final-dataset" class="nav-link" data-scroll-target="#visualize-the-final-dataset">Visualize the final dataset</a></li>
  </ul></li>
  <li><a href="#ml-training" id="toc-ml-training" class="nav-link" data-scroll-target="#ml-training">ML Training</a>
  <ul class="collapse">
  <li><a href="#prepare-data-into-x-y-and-generate-traintest-partitions" id="toc-prepare-data-into-x-y-and-generate-traintest-partitions" class="nav-link" data-scroll-target="#prepare-data-into-x-y-and-generate-traintest-partitions">Prepare data into X, y and generate train/test partitions</a></li>
  <li><a href="#evaluation-function" id="toc-evaluation-function" class="nav-link" data-scroll-target="#evaluation-function">Evaluation Function</a></li>
  <li><a href="#fit-and-evaluate-model" id="toc-fit-and-evaluate-model" class="nav-link" data-scroll-target="#fit-and-evaluate-model">Fit and Evaluate Model</a></li>
  </ul></li>
  <li><a href="#ml-rollout-phl" id="toc-ml-rollout-phl" class="nav-link" data-scroll-target="#ml-rollout-phl">ML Rollout (Phl)</a>
  <ul class="collapse">
  <li><a href="#generate-country-wide-tiles" id="toc-generate-country-wide-tiles" class="nav-link" data-scroll-target="#generate-country-wide-tiles">Generate country-wide tiles</a></li>
  <li><a href="#feature-engineering-1" id="toc-feature-engineering-1" class="nav-link" data-scroll-target="#feature-engineering-1">Feature Engineering</a></li>
  <li><a href="#make-predictions-and-viz-output" id="toc-make-predictions-and-viz-output" class="nav-link" data-scroll-target="#make-predictions-and-viz-output">Make predictions and viz output</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/butchtm/geowrangler2/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Explore Poverty Mapping Machine Learning Models</h1>
</div>

<div>
  <div class="description">
    Building Poverty Mapping Machine Learning (ML) Models with geowrangler2
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>The aim of this notebook is to demonstrate how geowrangler2 can be used to make the process of generating ML-ready or analytics-ready datasets from raw geospatial data easier.</p>
<p>Concretely, this shows a sample workflow for a wealth estimation model trained on a dataset constructed using: * Ground Truth - <a href="https://dhsprogram.com/">DHS</a> household clusters + wealth indices * Features - Derived from Night Time Lights, OSM POIs, and Ookla internet speeds.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>the goal here is to showcase geowrangler2’s functions for geospatial data wrangling and feature engineering. Hence, this notebook keeps the ML modelling portions as simple as possible.*</p>
</div>
</div>
<section id="set-up" class="level2">
<h2 class="anchored" data-anchor-id="set-up">Set-up</h2>
<p>Install and import some libraries.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sklearn</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely <span class="im">import</span> wkt</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geowrangler2.area_zonal_stats <span class="im">as</span> azs</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geowrangler2.distance_zonal_stats <span class="im">as</span> dzs</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geowrangler2.raster_zonal_stats <span class="im">as</span> rzs</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geowrangler2.vector_zonal_stats <span class="im">as</span> vzs</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geowrangler2 <span class="im">import</span> grids</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geowrangler2.datasets <span class="im">import</span> geofabrik, ookla</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pre-requisite-manual-data-download" class="level2">
<h2 class="anchored" data-anchor-id="pre-requisite-manual-data-download">Pre-requisite: Manual Data Download</h2>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># no_test</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># download data if not yet available</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>[ <span class="op">!</span> <span class="op">-</span>e ..<span class="op">/</span>data<span class="op">/</span>phl_adm0.geojson ] <span class="op">&amp;&amp;</span> curl <span class="op">-</span>s <span class="op">-</span>o ..<span class="op">/</span>data<span class="op">/</span>phl_adm0.geojson https:<span class="op">//</span>raw.githubusercontent.com<span class="op">/</span>thinkingmachines<span class="op">/</span>geowrangler2<span class="op">/</span>master<span class="op">/</span>data<span class="op">/</span>phl_adm0.geojson</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>[ <span class="op">!</span> <span class="op">-</span>e ..<span class="op">/</span>data<span class="op">/</span>phl_dhs_cluster_level.csv ] <span class="op">&amp;&amp;</span> curl <span class="op">-</span>s <span class="op">-</span>o ..<span class="op">/</span>data<span class="op">/</span>phl_dhs_cluster_level.csv https:<span class="op">//</span>raw.githubusercontent.com<span class="op">/</span>thinkingmachines<span class="op">/</span>geowrangler2<span class="op">/</span>master<span class="op">/</span>data<span class="op">/</span>phl_dhs_cluster_level.csv</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>[ <span class="op">!</span> <span class="op">-</span>e ..<span class="op">/</span>data<span class="op">/</span>phl_ntl.tif ] <span class="op">&amp;&amp;</span> curl <span class="op">-</span>s <span class="op">-</span>o ..<span class="op">/</span>data<span class="op">/</span>phl_ntl.tif https:<span class="op">//</span>raw.githubusercontent.com<span class="op">/</span>thinkingmachines<span class="op">/</span>geowrangler2<span class="op">/</span>master<span class="op">/</span>data<span class="op">/</span>phl_ntl.tif</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>DATA_DIR <span class="op">=</span> Path(<span class="st">"../data/"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Auto-creates the folder if it does not exist</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>DATA_DIR.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Your data directory should look something like this.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="data:image/png;base64,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.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">data_dir.PNG</figcaption>
</figure>
</div>
</section>
<section id="data-preparation" class="level2">
<h2 class="anchored" data-anchor-id="data-preparation">Data Preparation</h2>
<section id="dhs-ground-truth" class="level3">
<h3 class="anchored" data-anchor-id="dhs-ground-truth">DHS Ground Truth</h3>
<p>The ground truth used in this demo notebook is from a DHS 2017 on-the-ground household survey conducted in the Philippines regarding the households’ socio-demographic information.</p>
<p>The file we provide is already a pre-processed version of the data that is aggregated on a household-cluster level, meaning the information cannot be tied back to any individual household. Specifically, we only provide a list of household clusters with their corresponding (jittered) GPS coordinate and DHS-computed wealth index.</p>
<p>Due to the sensitive nature of the data and the DHS program terms of use, we cannot provide the raw data. You can, however, request for access to raw data yourself on the <a href="https://dhsprogram.com/data/new-user-registration.cfm">DHS website</a>. In that case, you can use geowrangler2’s <a href="https://geowrangler2.thinkingmachin.es/tutorial.dhs.html">DHS processing utils</a> help perform the said pre-processing.</p>
<p>Our first step is to create a GeoDataFrame from the data.</p>
<div class="cell" data-outputid="a117c5be-cae1-4a60-c56a-f95630a27618" data-execution_count="7">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load ground truth data as a DataFrame first</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>GROUND_TRUTH_CSV <span class="op">=</span> DATA_DIR <span class="op">/</span> <span class="st">"phl_dhs_cluster_level.csv"</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(GROUND_TRUTH_CSV)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Some of the coordinates in the data are invalid. This filters them out.</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[(df.longitude <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;</span> (df.latitude <span class="op">&gt;</span> <span class="dv">0</span>)]</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a GeoDataFrame from the longitude, latitude columns.</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> gpd.GeoDataFrame(</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    df, geometry<span class="op">=</span>gpd.points_from_xy(df.longitude, df.latitude), crs<span class="op">=</span><span class="st">"epsg:4326"</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"There are </span><span class="sc">{</span><span class="bu">len</span>(gdf)<span class="sc">:,}</span><span class="ss"> clusters."</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>gdf.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 1,213 clusters.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">DHSCLUST</th>
<th data-quarto-table-cell-role="th">Wealth Index</th>
<th data-quarto-table-cell-role="th">DHSID</th>
<th data-quarto-table-cell-role="th">longitude</th>
<th data-quarto-table-cell-role="th">latitude</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>-31881.60870</td>
<td>PH201700000001</td>
<td>122.109807</td>
<td>6.674652</td>
<td>POINT (122.10981 6.67465)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>-2855.37500</td>
<td>PH201700000002</td>
<td>122.132027</td>
<td>6.662256</td>
<td>POINT (122.13203 6.66226)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>-57647.04762</td>
<td>PH201700000003</td>
<td>122.179496</td>
<td>6.621822</td>
<td>POINT (122.17950 6.62182)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>-54952.66667</td>
<td>PH201700000004</td>
<td>122.137965</td>
<td>6.485298</td>
<td>POINT (122.13796 6.48530)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>6</td>
<td>-80701.69565</td>
<td>PH201700000006</td>
<td>121.916094</td>
<td>6.629457</td>
<td>POINT (121.91609 6.62946)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Next, we want to create a buffer around each cluster centroid that represents the area’s neighborhood. This is so we can engineer some features and characterize these neighborhoods using open data.</p>
<p><em>This is a design decision, but for this demo, we’ll create a circlular area with a 2km radius following the random displacement introduced by DHS to preserve household privacy.</em></p>
<div class="cell" data-outputid="1e7ce8c7-0fd5-4d1f-9023-d5475955e6d1" data-execution_count="8">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure to convert to PH crs first for the buffer in meters, and then back to WGS84</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> gdf.to_crs(<span class="st">"epsg:3123"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>gdf.geometry <span class="op">=</span> gdf.geometry.<span class="bu">buffer</span>(<span class="dv">2000</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> gdf.to_crs(<span class="st">"epsg:4326"</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>gdf.head(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">DHSCLUST</th>
<th data-quarto-table-cell-role="th">Wealth Index</th>
<th data-quarto-table-cell-role="th">DHSID</th>
<th data-quarto-table-cell-role="th">longitude</th>
<th data-quarto-table-cell-role="th">latitude</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>-31881.60870</td>
<td>PH201700000001</td>
<td>122.109807</td>
<td>6.674652</td>
<td>POLYGON ((122.12789 6.67461, 122.12780 6.67284...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>-2855.37500</td>
<td>PH201700000002</td>
<td>122.132027</td>
<td>6.662256</td>
<td>POLYGON ((122.15011 6.66221, 122.15002 6.66044...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>-57647.04762</td>
<td>PH201700000003</td>
<td>122.179496</td>
<td>6.621822</td>
<td>POLYGON ((122.19758 6.62178, 122.19749 6.62001...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>-54952.66667</td>
<td>PH201700000004</td>
<td>122.137965</td>
<td>6.485298</td>
<td>POLYGON ((122.15604 6.48526, 122.15595 6.48349...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>6</td>
<td>-80701.69565</td>
<td>PH201700000006</td>
<td>121.916094</td>
<td>6.629457</td>
<td>POLYGON ((121.93418 6.62942, 121.93409 6.62765...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We can visualize what we’ve done so far on a map.</p>
<div class="cell" data-outputid="789468ab-aeee-41a5-d0e5-b9160e338b5b" data-execution_count="9">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Uncomment the next line to display an interactive map</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># gdf.explore()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="download-data-and-load-them-into-memory" class="level3">
<h3 class="anchored" data-anchor-id="download-data-and-load-them-into-memory">Download data and load them into memory</h3>
<p>Next, we’ll download some data from Ookla (internet speeds) and OSM (points of interest), which we’ll use to generate neighborhood characteristics to be used as ML features.</p>
</section>
<section id="ookla" class="level3">
<h3 class="anchored" data-anchor-id="ookla">Ookla</h3>
<p><a href="https://www.ookla.com/ookla-for-good/open-data">Ookla has released global open data</a> gathered from speedtests made on their platform. This gives us access to internet speed information across various geographies. In our context, this can give us a signal predictor.</p>
<p>First, let’s download a local copy of data on fixed internet in the 1st quarter of 2019 (earliest data available).</p>
<p>We can use <a href="https://geowrangler2.thinkingmachin.es/tutorial.datasets.html#Downloading-Ookla-Data">geowrangler2’s Ookla data utility</a> to automatically download and cache the desired data on your machine given the type, year, and quarter.</p>
<p>This is just a simplification for the demo. In practice, you might want to aggregate data across multiple time periods or incorporate wireless data.</p>
<div class="cell" data-outputid="b6600926-a559-4c1f-d606-736086f64349" data-execution_count="10">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>ookla_fixed_2019_q1_filepath <span class="op">=</span> ookla.download_ookla_file(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    type_<span class="op">=</span><span class="st">"fixed"</span>, year<span class="op">=</span><span class="st">"2019"</span>, quarter<span class="op">=</span><span class="st">"1"</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># This is where the downloaded file is located.</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># By default this downloads to your data/ folder, but you can customize this.</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>ookla_fixed_2019_q1_filepath</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>Path('data/2019-01-01_performance_fixed_tiles.parquet')</code></pre>
</div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This is a function to load and do some light pre-processing on the Ookla data.</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_ookla_data(filename, mask<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ookla's parquet file doesn't seem to have geo metadata so need to read through pandas first</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    ookla_df <span class="op">=</span> pd.read_parquet(filename)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    ookla_gdf <span class="op">=</span> gpd.GeoDataFrame(</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        ookla_df,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        geometry<span class="op">=</span>ookla_df[<span class="st">"tile"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: wkt.loads(x)),</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        crs<span class="op">=</span><span class="st">"epsg:4326"</span>,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    ookla_gdf.drop(columns<span class="op">=</span>[<span class="st">"tile"</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ookla's data files contain data for the whole world.</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For our case, we're retaining only tiles that intersect with the given mask.</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This is to speed-up any processing we do later on.</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mask <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        keep_cols <span class="op">=</span> ookla_gdf.columns</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        ookla_gdf <span class="op">=</span> ookla_gdf.sjoin(mask, how<span class="op">=</span><span class="st">"inner"</span>, predicate<span class="op">=</span><span class="st">"intersects"</span>)</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        ookla_gdf <span class="op">=</span> ookla_gdf[keep_cols]</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        ookla_gdf.head()</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert kbps to mbps for easier reading</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    ookla_gdf[<span class="st">"avg_d_mbps"</span>] <span class="op">=</span> ookla_gdf[<span class="st">"avg_d_kbps"</span>] <span class="op">/</span> <span class="dv">1000</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    ookla_gdf[<span class="st">"avg_u_mbps"</span>] <span class="op">=</span> ookla_gdf[<span class="st">"avg_u_kbps"</span>] <span class="op">/</span> <span class="dv">1000</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ookla_gdf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The Ookla data is quite large, and takes around 5 minutes to load.</p>
<div class="cell" data-outputid="38a21bf1-4ab4-4cb0-be15-3892c287efdb" data-execution_count="12">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>ookla_gdf <span class="op">=</span> load_ookla_data(ookla_fixed_2019_q1_filepath, mask<span class="op">=</span>gdf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 1min 59s, sys: 38.7 s, total: 2min 38s
Wall time: 2min 38s</code></pre>
</div>
</div>
<div class="cell" data-outputid="e937c644-fb78-451e-9f78-d34cbb98e60d" data-execution_count="13">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"</span><span class="sc">{</span><span class="bu">len</span>(ookla_gdf)<span class="sc">:,}</span><span class="ss"> Ookla data tiles retained that intersect with our DHS cluster neighborhoods."</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>ookla_gdf.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>17,245 Ookla data tiles retained that intersect with our DHS cluster neighborhoods.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">quadkey</th>
<th data-quarto-table-cell-role="th">avg_d_kbps</th>
<th data-quarto-table-cell-role="th">avg_u_kbps</th>
<th data-quarto-table-cell-role="th">avg_lat_ms</th>
<th data-quarto-table-cell-role="th">tests</th>
<th data-quarto-table-cell-role="th">devices</th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">avg_d_mbps</th>
<th data-quarto-table-cell-role="th">avg_u_mbps</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">4368240</td>
<td>1323011210311031</td>
<td>10</td>
<td>21</td>
<td>126</td>
<td>1</td>
<td>1</td>
<td>POLYGON ((121.96472 20.45790, 121.97021 20.457...</td>
<td>0.010</td>
<td>0.021</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4368241</td>
<td>1323011210311033</td>
<td>5931</td>
<td>10633</td>
<td>228</td>
<td>3</td>
<td>2</td>
<td>POLYGON ((121.96472 20.45275, 121.97021 20.452...</td>
<td>5.931</td>
<td>10.633</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4368242</td>
<td>1323011210311122</td>
<td>13063</td>
<td>9266</td>
<td>218</td>
<td>5</td>
<td>2</td>
<td>POLYGON ((121.97021 20.45275, 121.97571 20.452...</td>
<td>13.063</td>
<td>9.266</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4368243</td>
<td>1323011210311211</td>
<td>20</td>
<td>51</td>
<td>130</td>
<td>1</td>
<td>1</td>
<td>POLYGON ((121.96472 20.44760, 121.97021 20.447...</td>
<td>0.020</td>
<td>0.051</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4368245</td>
<td>1323011210311230</td>
<td>195</td>
<td>589</td>
<td>114</td>
<td>1</td>
<td>1</td>
<td>POLYGON ((121.95923 20.43731, 121.96472 20.437...</td>
<td>0.195</td>
<td>0.589</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="osm-open-street-maps" class="level3">
<h3 class="anchored" data-anchor-id="osm-open-street-maps">OSM (Open Street Maps)</h3>
<p>One source of open data on points of interest is OSM. We’ll use the version of the data provided by Geofabrik vs accessing the OSM Overpass API. This allows us to not be bottlenecked by API calls.</p>
<p>Similar to Ookla, we can also use <a href="https://geowrangler2.thinkingmachin.es/tutorial.datasets.html#Downloading-Geofabrik-Data">geowrangler2’s OSM data download utils</a> to download and cache OSM data on your machine. All you have to do is specify the country you want.</p>
<p>Geofabrik’s OSM data is a zip file containing different files for POIs, waterways, roads, etc. For this demo notebook, we’ll only use the POIs.</p>
<div class="cell" data-outputid="15684467-d7fd-4823-fe3c-add66f88491b" data-execution_count="14">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This download can take around 1-2 minutes.</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>ph_osm_zip_path <span class="op">=</span> geofabrik.download_geofabrik_region(<span class="st">"philippines"</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># This line unzips the zip file if we haven't done so yet.</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>echo <span class="st">'None'</span> <span class="op">|</span> unzip $ph_osm_zip_path <span class="op">-</span>d data<span class="op">/</span>ph_osm<span class="op">/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Archive:  data/philippines-latest-free.shp.zip
replace data/ph_osm/README? [y]es, [n]o, [A]ll, [N]one, [r]ename: </code></pre>
</div>
</div>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Uncomment the ff line to see all the available OSM files aside from POIs.</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>ls <span class="op">-</span>aldh data<span class="op">/</span>ph_osm<span class="op">/*</span>.shp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>-rw-r--r-- 1 butchtm butchtm  100 Jan  5 17:50 data/ph_osm/gis_osm_buildings_a_free_1.shp
-rw-r--r-- 1 butchtm butchtm  100 Jan  5 17:50 data/ph_osm/gis_osm_landuse_a_free_1.shp
-rw-r--r-- 1 butchtm butchtm  100 Jan  5 17:50 data/ph_osm/gis_osm_natural_a_free_1.shp
-rw-r--r-- 1 butchtm butchtm 763K Jan  5 17:50 data/ph_osm/gis_osm_natural_free_1.shp
-rw-r--r-- 1 butchtm butchtm  100 Jan  5 17:50 data/ph_osm/gis_osm_places_a_free_1.shp
-rw-r--r-- 1 butchtm butchtm 1.1M Jan  5 17:50 data/ph_osm/gis_osm_places_free_1.shp
-rw-r--r-- 1 butchtm butchtm  100 Jan  5 17:50 data/ph_osm/gis_osm_pofw_a_free_1.shp
-rw-r--r-- 1 butchtm butchtm 102K Jan  5 17:50 data/ph_osm/gis_osm_pofw_free_1.shp
-rw-r--r-- 1 butchtm butchtm  100 Jan  5 17:50 data/ph_osm/gis_osm_pois_a_free_1.shp
-rw-r--r-- 1 butchtm butchtm 3.5M Jan  5 17:50 data/ph_osm/gis_osm_pois_free_1.shp
-rw-r--r-- 1 butchtm butchtm  100 Jan  5 17:50 data/ph_osm/gis_osm_railways_free_1.shp
-rw-r--r-- 1 butchtm butchtm  100 Jan  5 17:50 data/ph_osm/gis_osm_roads_free_1.shp
-rw-r--r-- 1 butchtm butchtm  100 Jan  5 17:50 data/ph_osm/gis_osm_traffic_a_free_1.shp
-rw-r--r-- 1 butchtm butchtm 1.1M Jan  5 17:50 data/ph_osm/gis_osm_traffic_free_1.shp
-rw-r--r-- 1 butchtm butchtm  100 Jan  5 17:50 data/ph_osm/gis_osm_transport_a_free_1.shp
-rw-r--r-- 1 butchtm butchtm 177K Jan  5 17:50 data/ph_osm/gis_osm_transport_free_1.shp
-rw-r--r-- 1 butchtm butchtm  100 Jan  5 17:50 data/ph_osm/gis_osm_water_a_free_1.shp
-rw-r--r-- 1 butchtm butchtm  100 Jan  5 17:50 data/ph_osm/gis_osm_waterways_free_1.shp</code></pre>
</div>
</div>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>ph_osm_pois_filepath <span class="op">=</span> <span class="st">"data/gis_osm_pois_free_1.shp"</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>ph_osm <span class="op">=</span> gpd.read_file(ph_osm_pois_filepath)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="d42df7b1-cffa-4c1f-c818-4a5735ecfcae" data-execution_count="25">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"There are </span><span class="sc">{</span><span class="bu">len</span>(ph_osm)<span class="sc">}</span><span class="ss"> OSM POIs."</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>ph_osm.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 0 OSM POIs.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="25">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">osm_id</th>
<th data-quarto-table-cell-role="th">code</th>
<th data-quarto-table-cell-role="th">fclass</th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="feature-engineering" class="level2">
<h2 class="anchored" data-anchor-id="feature-engineering">Feature Engineering</h2>
<p>Now that we’ve prepared the DHS data and loaded Ookla and OSM data into memory, we’re ready to generate some neighborhood features for our ML model.</p>
<p>For convenience, we’re wrapping all the feature engineering code in functions so we can re-use them later when we apply the model to the whole country.</p>
<p><em>Note: if you are modifying the feature engineering portions, it is recommended to run the whole section end-to-end. This ensures you’re starting fresh from a new copy of the DHS clusters GeoDataFrame. This also ensures the function definitions are up-to-date, and can be re-used properly later for model rollout.</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll make a copy of the GDF to avoid overwriting the original DHS GeoDataFrame.</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>gdf_with_features <span class="op">=</span> gdf.copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="osm" class="level3">
<h3 class="anchored" data-anchor-id="osm">OSM</h3>
<p>Our goal with OSM data is to generate neighborhood characteristics based on counts and distance to certain POIs, such as schools, hospitals, etc.</p>
<p>To do this, we utilize geowrangler2’s <a href="https://geowrangler2.thinkingmachin.es/tutorial.vector_zonal_stats.html">vector zonal stats</a> and <a href="https://geowrangler2.thinkingmachin.es/tutorial.distance_zonal_stats.html">distance zonal stats</a> features.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Uncomment the ff. line if you want to see the different POI classes available</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ph_osm.fclass.sort_values().unique()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_osm_features(aoi, osm, metric_crs<span class="op">=</span><span class="st">"epsg:3123"</span>):</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    aoi <span class="op">=</span> aoi.copy()</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># geowrangler2: Count number of all POIs per tile</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    aoi <span class="op">=</span> vzs.create_zonal_stats(</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>        aoi,</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>        osm,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>        overlap_method<span class="op">=</span><span class="st">"intersects"</span>,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>        aggregations<span class="op">=</span>[{<span class="st">"func"</span>: <span class="st">"count"</span>, <span class="st">"output"</span>: <span class="st">"poi_count"</span>, <span class="st">"fillna"</span>: <span class="va">True</span>}],</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Count specific aoi types</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    poi_types <span class="op">=</span> [<span class="st">"restaurant"</span>, <span class="st">"school"</span>, <span class="st">"bank"</span>, <span class="st">"supermarket"</span>, <span class="st">"mall"</span>, <span class="st">"atm"</span>]</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> poi_type <span class="kw">in</span> poi_types:</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># geowrangler2: Count with vector zonal stats</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>        aoi <span class="op">=</span> vzs.create_zonal_stats(</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>            aoi,</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>            osm[osm[<span class="st">"fclass"</span>] <span class="op">==</span> poi_type],</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>            overlap_method<span class="op">=</span><span class="st">"intersects"</span>,</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>            aggregations<span class="op">=</span>[</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>                {<span class="st">"func"</span>: <span class="st">"count"</span>, <span class="st">"output"</span>: <span class="ss">f"</span><span class="sc">{</span>poi_type<span class="sc">}</span><span class="ss">_count"</span>, <span class="st">"fillna"</span>: <span class="va">True</span>}</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>            ],</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># geowrangler2: Distance with distance zonal stats</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>        col_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>poi_type<span class="sc">}</span><span class="ss">_nearest"</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>        aoi <span class="op">=</span> dzs.create_distance_zonal_stats(</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>            aoi.to_crs(metric_crs),</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>            osm[osm[<span class="st">"fclass"</span>] <span class="op">==</span> poi_type].to_crs(metric_crs),</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>            max_distance<span class="op">=</span><span class="dv">10_000</span>,</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>            aggregations<span class="op">=</span>[],</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>            distance_col<span class="op">=</span>col_name,</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>        ).to_crs(<span class="st">"epsg:4326"</span>)</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If no POI was found within the distance limit, set the distance to a really high value</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>        aoi[col_name] <span class="op">=</span> aoi[col_name].fillna(value<span class="op">=</span><span class="dv">999999</span>)</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> aoi</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="2fe46273-4c88-4760-9a8a-c73ae597d804">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>gdf_with_features <span class="op">=</span> generate_osm_features(gdf_with_features, ph_osm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="6b117b95-819c-49d2-f3ec-45605af1a200">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>gdf_with_features.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="ookla-1" class="level3">
<h3 class="anchored" data-anchor-id="ookla-1">Ookla</h3>
<p>Our goal with Ookla data is to generate neighborhood characteristics based on internet speeds (download, upload, latency).</p>
<p>To do this, we utilize geowrangler2’s <a href="https://geowrangler2.thinkingmachin.es/tutorial.area_zonal_stats.html">area zonal stats</a> feature.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_ookla_features(aoi, ookla_gdf, metric_crs<span class="op">=</span><span class="st">"epsg:3123"</span>):</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    aoi <span class="op">=</span> aoi.copy()</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    orig_aoi_crs <span class="op">=</span> aoi.crs</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    aoi <span class="op">=</span> aoi.to_crs(metric_crs)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    ookla_gdf <span class="op">=</span> ookla_gdf.to_crs(metric_crs)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For better formatting, rename some columns</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    ookla_gdf <span class="op">=</span> ookla_gdf.rename(</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>{<span class="st">"avg_d_mbps"</span>: <span class="st">"d_mbps"</span>, <span class="st">"avg_u_mbps"</span>: <span class="st">"u_mbps"</span>, <span class="st">"avg_lat_ms"</span>: <span class="st">"lat_ms"</span>}</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># geowrangler2: Compute stats on the various columns</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    aoi <span class="op">=</span> azs.create_area_zonal_stats(</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>        aoi,</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>        ookla_gdf,</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>        aggregations<span class="op">=</span>[</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Count number of devices in the area</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>            <span class="bu">dict</span>(column<span class="op">=</span><span class="st">"devices"</span>, func<span class="op">=</span>[<span class="st">"raw_sum"</span>], fillna<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get stats on the download speeds</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>            <span class="bu">dict</span>(</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>                column<span class="op">=</span><span class="st">"d_mbps"</span>,</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>                func<span class="op">=</span>[<span class="st">"imputed_mean"</span>, <span class="st">"max"</span>, <span class="st">"min"</span>, <span class="st">"std"</span>],</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>                fillna<span class="op">=</span>[<span class="va">True</span>, <span class="va">True</span>, <span class="va">True</span>, <span class="va">True</span>],</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get stats on the upload speeds</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>            <span class="bu">dict</span>(</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>                column<span class="op">=</span><span class="st">"u_mbps"</span>,</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>                func<span class="op">=</span>[<span class="st">"imputed_mean"</span>, <span class="st">"max"</span>, <span class="st">"min"</span>, <span class="st">"std"</span>],</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>                fillna<span class="op">=</span>[<span class="va">True</span>, <span class="va">True</span>, <span class="va">True</span>, <span class="va">True</span>],</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Don't include the land area that intersected as a column</span></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>        include_intersect<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Don't set minimum values to 0 if the neighborhood's area doesn't fully intersect with Ookla tiles.</span></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>        fix_min<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>    aoi <span class="op">=</span> aoi.fillna(value<span class="op">=</span><span class="st">"0"</span>)</span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>    aoi <span class="op">=</span> aoi.to_crs(orig_aoi_crs)</span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> aoi</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="4d2d8290-af69-4eb0-fc71-7a516b1f30b9">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>gdf_with_features <span class="op">=</span> generate_ookla_features(gdf_with_features, ookla_gdf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="14c1cbfa-9bcc-4c46-a14c-0d5a7c0b88a3">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>gdf_with_features.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="night-time-lights" class="level3">
<h3 class="anchored" data-anchor-id="night-time-lights">Night Time Lights</h3>
<p>Lastly, we’ll generate features based on night time lights. <a href="https://geowrangler2.thinkingmachin.es/tutorial.raster_zonal_stats.html">geowrangler2 provides a raster zonal stats function</a> that acts as a thin layer on top of rasterio’s rasterstats function. It provides a little convenience in terms of formatting and automatically joins back the features to your input GeoDataFrame.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_ntl_features(aoi, raster_path):</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    aoi <span class="op">=</span> aoi.copy()</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    aoi <span class="op">=</span> rzs.create_raster_zonal_stats(</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>        aoi,</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>        raster_path,</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>        aggregation<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>            func<span class="op">=</span>[<span class="st">"mean"</span>, <span class="st">"min"</span>, <span class="st">"max"</span>, <span class="st">"std"</span>],</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>            column<span class="op">=</span><span class="st">"ntl"</span>,</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>        extra_args<span class="op">=</span><span class="bu">dict</span>(nodata<span class="op">=</span><span class="dv">0</span>),</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    aoi.fillna(<span class="dv">0</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> aoi</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="f29d8c06-5503-4b59-ad6a-b9293b9af10a">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>gdf_with_features <span class="op">=</span> generate_ntl_features(gdf_with_features, DATA_DIR <span class="op">/</span> <span class="st">"phl_ntl.tif"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualize-the-final-dataset" class="level3">
<h3 class="anchored" data-anchor-id="visualize-the-final-dataset">Visualize the final dataset</h3>
<p>Finally, let’s visualize our cluster neighborhoods now with the generated features. Hover over each cluster to see its data.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/dhs-cluster-features-zoomed.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">DHS Cluster Features (Zoomed)</figcaption>
</figure>
</div>
<div class="cell" data-outputid="e17b7a55-0184-4f87-9ff8-0be9ad24b943">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the clusters with the generated features</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co"># gdf_with_features.explore()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="ml-training" class="level1">
<h1>ML Training</h1>
<p>In this section, we will now train an ML model to predict the wealth index for an area given its features.</p>
<section id="prepare-data-into-x-y-and-generate-traintest-partitions" class="level2">
<h2 class="anchored" data-anchor-id="prepare-data-into-x-y-and-generate-traintest-partitions">Prepare data into X, y and generate train/test partitions</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For convenience, store the list of features in a variable. Remove all extraneous columns.</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>feature_cols <span class="op">=</span> gdf_with_features.drop(</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"DHSCLUST"</span>, <span class="st">"DHSID"</span>, <span class="st">"Wealth Index"</span>, <span class="st">"longitude"</span>, <span class="st">"latitude"</span>, <span class="st">"geometry"</span>]</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>).columns</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Separate data (X) and the target (y)</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> gdf_with_features[feature_cols]</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> gdf_with_features[<span class="st">"Wealth Index"</span>]</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Bin y into 5 buckets for stratification when splitting the dataset</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>cat_y <span class="op">=</span> pd.cut(y, bins<span class="op">=</span><span class="dv">5</span>, labels<span class="op">=</span><span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">6</span>)))</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate train and test partitions</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> sklearn.model_selection.train_test_split(</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    X, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">2022</span>, stratify<span class="op">=</span>cat_y</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="fb31e265-a9d3-43bb-b571-186501dda894">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>X_train.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="9d53912a-2974-4bcb-eef9-482d061226f2">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>y_train.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="evaluation-function" class="level2">
<h2 class="anchored" data-anchor-id="evaluation-function">Evaluation Function</h2>
<p>We define an evaluation function that computes R^2 and makes a plot of the actual vs predicted values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate(model, X_train, X_test, y_train, y_test):</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># R^2</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    train_predictions <span class="op">=</span> model.predict(X_train)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Train R2 score:"</span>, sklearn.metrics.r2_score(y_train, train_predictions))</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    test_predictions <span class="op">=</span> model.predict(X_test)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Test R2 score:"</span>, sklearn.metrics.r2_score(y_test, test_predictions))</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train and test predictions vs actual values</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    plt.scatter(train_predictions, y_train, label<span class="op">=</span><span class="st">"Train samples"</span>, c<span class="op">=</span><span class="st">"#d95f02"</span>)</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    plt.scatter(test_predictions, y_test, label<span class="op">=</span><span class="st">"Test samples"</span>, c<span class="op">=</span><span class="st">"#7570b3"</span>)</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Identity line</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    xpoints <span class="op">=</span> ypoints <span class="op">=</span> plt.xlim()</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>    plt.plot(</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>        xpoints, ypoints, linestyle<span class="op">=</span><span class="st">"--"</span>, color<span class="op">=</span><span class="st">"k"</span>, lw<span class="op">=</span><span class="dv">3</span>, scalex<span class="op">=</span><span class="va">False</span>, scaley<span class="op">=</span><span class="va">False</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Labels and legends</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"Predicted value"</span>)</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"True value"</span>)</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fit-and-evaluate-model" class="level2">
<h2 class="anchored" data-anchor-id="fit-and-evaluate-model">Fit and Evaluate Model</h2>
<p>For ML modelling, let’s fit a simple random forest regressor.</p>
<p>As mentioned, we are keeping the ML modelling as simple as possible in this notebook. This is definitely not the best-performing wealth estimation model out there, but should be decent enough for demo purposes.</p>
<div class="cell" data-outputid="738af25b-919b-467e-fd23-1ba96e556fb2">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> RandomForestRegressor()</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>model.fit(X_train, y_train)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>evaluate(model, X_train, X_test, y_train, y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="ml-rollout-phl" class="level1">
<h1>ML Rollout (Phl)</h1>
<p>Now that we have a wealth estimation model, we can apply it to the whole country.</p>
<section id="generate-country-wide-tiles" class="level2">
<h2 class="anchored" data-anchor-id="generate-country-wide-tiles">Generate country-wide tiles</h2>
<p>First, we need to split the country up into smaller areas.</p>
<p>That usually means generating grid tiles or hex tiles for your area of interest. In this notebook, we’ll generate Bing tiles at zoom level 13 (which has the closest area to our 2km neighborhoods in training).</p>
<p><a href="https://geowrangler2.web.app/tutorial.grids.html">geowrangler2 provides various grid generation utilities</a> for these different scenarios.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in the admin boundary for PHL.</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This file is a simplified version of the admin boundary to make the file size smaller and load times faster.</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>phl_adm <span class="op">=</span> gpd.read_file(<span class="ss">f"</span><span class="sc">{</span>DATA_DIR<span class="sc">}</span><span class="ss">/phl_adm0.geojson"</span>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Uncomment this line if you want to visualize it</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co"># phl_adm.explore()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The generation can take around 1-2 minutes.</p>
<div class="cell" data-outputid="f91aace0-2081-4cd6-9e0c-6e23c900a882">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>phl_tiles <span class="op">=</span> grids.BingTileGridGenerator(<span class="dv">13</span>).generate_grid(phl_adm)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"There are </span><span class="sc">{</span><span class="bu">len</span>(phl_tiles)<span class="sc">:,}</span><span class="ss"> tiles."</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>phl_tiles.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="feature-engineering-1" class="level2">
<h2 class="anchored" data-anchor-id="feature-engineering-1">Feature Engineering</h2>
<p>This part is simpler, as we’re just re-using the feature engineering functions we previously created. Note though that we are generating features for a bigger area, so the runtime is a little longer (in total should be within 2 minutes).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>phl_tiles_with_features <span class="op">=</span> phl_tiles.copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="d2aa43fa-2764-4210-9f3e-68f25b62c2ac">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>phl_tiles_with_features <span class="op">=</span> generate_osm_features(phl_tiles_with_features, ph_osm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="c477a2dd-9c78-4e61-c56e-022e480b7275">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>phl_tiles_with_features <span class="op">=</span> generate_ookla_features(phl_tiles_with_features, ookla_gdf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="40d23778-b30c-4b7a-8dd3-77940b97a6a7">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>phl_tiles_with_features <span class="op">=</span> generate_ntl_features(</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    phl_tiles_with_features, <span class="ss">f"</span><span class="sc">{</span>DATA_DIR<span class="sc">}</span><span class="ss">/phl_ntl.tif"</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="make-predictions-and-viz-output" class="level2">
<h2 class="anchored" data-anchor-id="make-predictions-and-viz-output">Make predictions and viz output</h2>
<p>Finally, we are ready to apply the model and make predictions throughout the whole country. We can also visualize it on a Cholorpleth map.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>phl_tiles_with_features[<span class="st">"predicted_wealth_index"</span>] <span class="op">=</span> model.predict(</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    phl_tiles_with_features[feature_cols]</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> viz_chloropleth(gdf, target_feature<span class="op">=</span><span class="st">"predicted_wealth_index"</span>):</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">map</span> <span class="op">=</span> folium.Map(location<span class="op">=</span>[<span class="fl">14.6091</span>, <span class="fl">121.0223</span>], width<span class="op">=</span><span class="dv">1000</span>, height<span class="op">=</span><span class="dv">800</span>, zoom_start<span class="op">=</span><span class="dv">7</span>)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> gdf.copy()</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    subset[<span class="st">"id"</span>] <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="bu">len</span>(subset)))</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    folium.Choropleth(</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>        geo_data<span class="op">=</span>subset,</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>subset,</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"Wealth Predictions"</span>,</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>[<span class="st">"id"</span>, target_feature],</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>        key_on<span class="op">=</span><span class="st">"feature.properties.id"</span>,</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>        fill_color<span class="op">=</span><span class="st">"Spectral"</span>,</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>        legend_name<span class="op">=</span>target_feature,</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>    ).add_to(<span class="bu">map</span>)</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">map</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Visualize the output</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/predicted-wealth-rollout-ph.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Predicted Wealth Index Rollout (Philippines)</figcaption>
</figure>
</div>
<div class="cell" data-outputid="95fd1042-d7f5-40c2-b409-27021dd1248d">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Uncomment the line below to visualize rollout</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="co"># viz_chloropleth(phl_tiles_with_features)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://thinkingmachin.es">Copyright 2023 onwards, Thinking Machines Data Science Inc.</a>
  </li>  
</ul>
    </div>   
    <div class="nav-footer-center"><a href="https://thinkingmachin.es"><img src="images/company_logo_sm.png" class="img-fluid" alt="Thinking Machines Data Science Inc." width="65"></a></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/butchtm/geowrangler2">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>